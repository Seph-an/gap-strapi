import{bH as W,dM as U,u as k,a as L,bq as q,dN as N,j as e,e as x,I as D,ao as $,dO as z,dP as G,dQ as S,k as B,dR as T,cc as Q,cN as Y,h as X,T as Z,dS as _,dB as A,dT as J,dU as K,dV as ee,cO as H,bt as te,bo as v,bW as y,dG as se,ca as ne,r as I,dW as ae,dX as oe,dY as re,dZ as ie,dy as de,dz as ce,bw as le,dD as ue,dE as E,d_ as pe}from"./strapi-B8XjzIdc.js";import{F as me}from"./Input-JBCQxwlp.js";import{getDocumentStatus as F}from"./EditViewPage-B42QCdMX.js";import"./usePrev-B16Rb3Bk.js";import"./objects-Djr7ghJW.js";import"./getEmptyImage-CjqolaH3.js";import"./ComponentIcon-CCmJYiMg.js";const he=()=>{const[{query:s}]=k(),{formatMessage:i}=L(),o=T("BackButton",r=>r.canGoBack),d=T("BackButton",r=>r.goBack),l=T("BackButton",r=>r.history),n=T("BackButton",r=>r.currentLocationIndex),p=o?l.at(n-2):void 0,u={pathname:"..",search:Q.stringify(s,{encode:!1})},h=p??u,a=r=>{if(o){r.preventDefault(),d();return}};return e.jsx(D,{variant:"ghost",tag:Y,relative:"path",to:h,onClick:a,label:i({id:"content-manager.preview.header.close",defaultMessage:"Close preview"}),children:e.jsx(X,{})})},ge=()=>{const s=m("PreviewHeader",n=>n.document),i=m("PreviewHeader",n=>n.schema),o=m("PreviewHeader",n=>n.meta);if(!(i?.options?.draftAndPublish??!1))return null;const l=F(s,o);return e.jsx(_,{status:l,size:"XS"})},fe=()=>{const{formatMessage:s}=L(),[{query:i},o]=k(),d=m("PreviewHeader",a=>a.document),l=m("PreviewHeader",a=>a.schema),n=m("PreviewHeader",a=>a.meta),p=l?.options?.draftAndPublish??!1,u=F(d,n),h=a=>{(a==="published"||a==="draft")&&o({status:a},"push",!0)};return p?e.jsx(A.Root,{variant:"simple",value:i.status||"draft",onValueChange:h,children:e.jsxs(A.List,{"aria-label":s({id:"preview.tabs.label",defaultMessage:"Document status"}),children:[e.jsx(M,{value:"draft",children:s({id:"content-manager.containers.List.draft",defaultMessage:"draft"})}),e.jsx(M,{value:"published",disabled:u==="draft",children:s({id:"content-manager.containers.List.published",defaultMessage:"published"})})]})}):null},xe=()=>{const s=m("PreviewHeader",c=>c.title),i=m("PreviewHeader",c=>c.document),o=m("PreviewHeader",c=>c.schema),d=m("PreviewHeader",c=>c.meta),l=W("PreviewHeader",c=>c.plugins),n=U("PreviewHeader",c=>c.onPreview),[{query:p}]=k(),{formatMessage:u}=L(),{toggleNotification:h}=q(),{copy:a}=N(),r=()=>{a(window.location.href),h({message:u({id:"content-manager.preview.copy.success",defaultMessage:"Copied preview link"}),type:"success"})},t=o.options?.draftAndPublish??!1,f={activeTab:p.status??null,collectionType:o.kind==="collectionType"?"collection-types":"single-types",model:o.uid,documentId:i.documentId,document:i,meta:d,onPreview:n,fromPreview:!0};return e.jsxs(x,{height:"48px",gap:4,background:"neutral0",borderColor:"neutral150",tag:"header",children:[e.jsxs(we,{height:"100%",paddingLeft:2,paddingRight:4,children:[e.jsx(he,{}),e.jsx(ve,{tag:"h1",title:s,maxWidth:"200px",fontSize:2,paddingLeft:2,paddingRight:3,fontWeight:600,children:s}),e.jsx(ge,{})]}),e.jsxs(x,{flex:1,paddingRight:2,gap:2,justifyContent:t?"space-between":"flex-end",children:[e.jsx(x,{flex:"1 1 70%",children:e.jsx(fe,{})}),e.jsxs(x,{gap:2,children:[e.jsx(D,{type:"button",label:u({id:"preview.copy.label",defaultMessage:"Copy preview link"}),onClick:r,children:e.jsx($,{})}),e.jsx(z,{area:"preview.actions"}),e.jsx(G,{props:f,descriptions:l["content-manager"].apis.getDocumentActions("preview"),children:c=>{const C=c.filter(j=>[j.position].flat().includes("preview")),[g,w]=C;return!g&&!w?null:g&&w?e.jsxs(e.Fragment,{children:[e.jsx(S,{...w,variant:w.variant||"secondary"}),e.jsx(S,{...g,variant:g.variant||"default"})]}):e.jsx(S,{...g,variant:g.variant||"secondary"})}})]})]})]})},ve=B(Z)`
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
`,M=B(A.Trigger)`
  text-transform: uppercase;
`,we=B(x)`
  border-right: 1px solid ${({theme:s})=>s.colors.neutral150};
`,[je,m]=J("PreviewPage"),be=B(pe)`
  will-change: transform;
  rotate: ${s=>s.isSideEditorOpen?"0deg":"180deg"};
  transition: rotate 0.2s ease-in-out;
`,Pe=()=>{const s=ne(),{formatMessage:i}=L(),o=I.useRef(null),[d,l]=I.useState(!0),{slug:n,id:p,collectionType:u}=H(),[{query:h}]=k(),a=I.useMemo(()=>ae(h),[h]);if(!u)throw new Error("Could not find collectionType in url params");if(!n)throw new Error("Could not find model in url params");if(u===oe&&!p)throw new Error("Could not find documentId in url params");const r=re({params:{contentType:n},query:{documentId:p,locale:a.locale,status:a.status}}),t=ie({model:n,collectionType:u,documentId:p,params:a}),f=de(n);if((r.isLoading||f.isLoading||t.isLoading)&&!t.document?.documentId)return e.jsx(v.Loading,{});const C=t.getInitialFormValues();if(r.error||f.error||!t.document||!t.meta||!t.schema||!C)return e.jsx(v.Error,{});if(!r.data?.data?.url)return e.jsx(v.NoData,{});const g=t.getTitle(f.edit.settings.mainField),w=(b,P)=>E(t.schema?.attributes,t.components,{status:t.document?.status,...P}).validateSync(b,{abortEarly:!1}),j=r.data.data.url,O=()=>{o?.current?.contentWindow?.postMessage({type:"strapiUpdate"},new URL(o.current.src).origin)},R=window.strapi.features.isEnabled("cms-advanced-preview");return e.jsxs(e.Fragment,{children:[e.jsx(v.Title,{children:i({id:"content-manager.preview.page-title",defaultMessage:"{contentType} preview"},{contentType:g})}),e.jsx(ce,{initialDocument:{documentId:p||"",model:n,collectionType:u},onPreview:O,children:e.jsx(je,{url:j,document:t.document,title:g,meta:t.meta,schema:t.schema,layout:f.edit,children:e.jsx(le,{method:"PUT",disabled:h.status==="published"&&t&&t.document.status==="published",initialValues:t.getInitialFormValues(),initialErrors:s?.state?.forceValidation?w(C,{}):{},height:"100%",validate:(b,P)=>E(t.schema?.attributes,t.components,{status:t.document?.status,...P}).validate(b,{abortEarly:!1}),children:({resetForm:b})=>e.jsxs(x,{direction:"column",height:"100%",alignItems:"stretch",children:[e.jsx(ue,{onProceed:b}),e.jsx(xe,{}),e.jsxs(x,{flex:1,overflow:"auto",alignItems:"stretch",children:[R&&e.jsx(y,{overflow:"auto",width:d?"50%":0,borderWidth:"0 1px 0 0",borderColor:"neutral150",paddingTop:6,paddingBottom:6,paddingLeft:d?6:0,paddingRight:d?6:0,transition:"all 0.2s ease-in-out",children:e.jsx(me,{layout:f.edit.layout,document:t,hasBackground:!1})}),e.jsxs(y,{position:"relative",flex:1,height:"100%",overflow:"hidden",children:[e.jsx(y,{"data-testid":"preview-iframe",ref:o,src:j,title:i({id:"content-manager.preview.panel.title",defaultMessage:"Preview"}),width:"100%",height:"100%",borderWidth:0,tag:"iframe"},j),R&&e.jsx(D,{variant:"tertiary",label:i(d?{id:"content-manager.preview.content.close-editor",defaultMessage:"Close editor"}:{id:"content-manager.preview.content.open-editor",defaultMessage:"Open editor"}),onClick:()=>l(P=>!P),position:"absolute",top:2,left:2,children:e.jsx(be,{isSideEditorOpen:d})})]})]})]})})})})]})},ye=()=>{const{slug:s}=H(),{permissions:i=[],isLoading:o,error:d}=te([{action:"plugin::content-manager.explorer.read",subject:s},{action:"plugin::content-manager.explorer.update",subject:s},{action:"plugin::content-manager.explorer.publish",subject:s}]);return o?e.jsx(v.Loading,{}):d||!s?e.jsx(y,{height:"100vh",width:"100vw",position:"fixed",top:0,left:0,zIndex:2,background:"neutral0",children:e.jsx(v.Error,{})}):e.jsx(y,{height:"100vh",width:"100vw",position:"fixed",top:0,left:0,zIndex:2,background:"neutral0",children:e.jsx(v.Protect,{permissions:i.filter(l=>l.action.includes("explorer.read")),children:e.jsx(se,{permissions:i,children:e.jsx(Pe,{})})})})},Ae=()=>e.jsx(K,{children:e.jsx(ee,{children:e.jsx(ye,{})})});export{Ae as ProtectedPreviewPage,m as usePreviewContext};
